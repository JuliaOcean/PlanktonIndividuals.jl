# Model Configuration

This section describes all the options and features that can be used to set up a `PI_Model`.

Below are all the options or keyword arguments that can be passed to `PI_Model`.
Checkout different sections for more details and examples for each keyword argument.

```@docs
PI_Model
```

## Architecture

Passing `arch = CPU()` or `arch = GPU()` to the `PI_Model` constructor will determine whether the model
is time stepped on a CPU or GPU.

Users do not need to modify the setup or simulation script to change the architecture to run on.
The only thing needs to be changed is `arch = CPU()` or `arch = GPU()`.

!!! tip "Running on GPUs"
    If you are having issues with running `PlanktonIndividuals` on a GPU, please
    [open an issue](https://github.com/JuliaOcean/PlanktonIndividuals.jl/issues/new) and we'll do our best to help out.

## Grid

We now only support `RegularRectilinearGrid` with constant grid spacing.
But the spacing can be different for each dimension.

The `RegularRectilinearGrid` is constructed by specifying `size` of the grid (which is a `Tuple`
specifying the number of grid points in each dimension) and `spacing` (which is a `Tuple` specifying
the length of each grid point in each dimension).
The topology is fixed as `(Periodic, Periodic, Bounded)`.

A regular rectilinear grid with ``32 \times 64 \times 128`` grid points and grid `spacing` of ``dx=1``m.
``dy=2``m, ``dz=4``m is constructed below:

```@meta
DocTestSetup = quote
    using PlanktonIndividuals
end
```

```jldoctest
julia> grid = RegularRectilinearGrid(size=(32, 64, 128), spacing=(1, 2, 4))
domain: x âˆˆ [0.0, 32.0], y âˆˆ [0.0, 128.0], z âˆˆ [0.0, -512.0]
resolution (Nx, Ny, Nz):   (32, 64, 128)
halo size (Hx, Hy, Hz):    (2, 2, 2)
grid spacing (Î”x, Î”y, Î”z): (1, 2, 4)
```

## Individuals

The number and species of individuals can be specified by passing `individual_size = (Nsp = 1, N = 1024, cap = 8)`
where `Nsp` is the number of species will be modeled, `N` is the number of individuals in each species,
`cap` is the maximum times of the number of individuals that can be held for each species.

!!! tip "The maximum number of species"
    The maximum number of species that can be modeled is `9`.

## Parameters

Default parameters are generated by two functions [here](https://github.com/JuliaOcean/PlanktonIndividuals.jl/blob/master/src/params/param_default.jl) as `Dict`s.
`bgc_params` contains the parameters for biogeochemical cycls.
`phyt_params` contains the parameters for phytoplankton individuals.

Users can change the values of the parameters by [`update_bgc_params`](@ref) and [`update_phyt_params`](@ref).
And example is shown below (change the value of `kDOC`, remineralization rate of DOC):

```jldoctest
julia> new_params = Dict("kDOC" => 0.01) # no need to include all parameters
Dict{String, Float64} with 1 entry:
  "kDOC" => 0.01

julia> update_bgc_params(new_params)
Dict{String, Float64} with 13 entries:
  "kc"   => 0.04
  "kDOC" => 0.01
  "ÎºhP"  => 0.0
  "kPON" => 3.85802e-7
  "kDON" => 3.85802e-7
  "Îºh"   => 1.0e-6
  "Îºv"   => 1.0e-6
  "kDOP" => 3.85802e-7
  "kPOP" => 3.85802e-7
  "kw"   => 0.046
  "Nit"  => 3.85802e-7
  "kPOC" => 3.85802e-7
  "ÎºvP"  => 0.0
```

`phyt_params` can be changed in the same way.

## Nutrient fields

Nutrient fields included in the model are listed below.
The initial conditions of the nutrient fields are generated by [`generate_nutrients`](@ref)
either from a 10-element `NamedTuple` or a `Dict` containing the file paths pointing to the files
of existing nutrient initial conditions. Please note: a 20% random noise is included if the initial
conditions are generated by `NamedTuple`.

|Name | Unit        | Description                                     |
|-----|-------------|-------------------------------------------------|
|DIC  |$mmol~C/m^3$ | concentration of dissolved inorganic carbon     |
|NH4  |$mmol~N/m^3$ | concentration of ammonia                        |
|NO3  |$mmol~N/m^3$ | concentration of nitrate                        |
|PO4  |$mmol~P/m^3$ | concentration of phosphate                      |
|DOC  |$mmol~C/m^3$ | concentration of dissolved organic carbon       |
|DON  |$mmol~N/m^3$ | concentration of dissolved organic nitrogen     |
|DOP  |$mmol~P/m^3$ | concentration of dissolved organic phosphorus   |
|POC  |$mmol~C/m^3$ | concentration of particulate organic carbon     |
|PON  |$mmol~N/m^3$ | concentration of particulate organic nitrogen   |
|POP  |$mmol~P/m^3$ | concentration of particulate organic phosphorus |

!!! tip "Nutrient Fields"
    The initial conditions of all the nutrient fields should be non-negative.

An example of the `NamedTuple` is listed below:

```julia
nut_init = (DIC=20.0, NH4=0.2, NO3=0.5, PO4=0.03, DOC=1.0, DON=0.1, DOP=0.05, POC=0.0, PON=0.0,POP=0.0)
```

And example of the `Dict` is listed below:

```julia
nut_init = Dict(
    DIC => "path/to/DIC.bin",
    NH4 => "path/to/NH4.bin",
    NO3 => "path/to/NO3.bin",
    PO4 => "path/to/PO4.bin",
    DOC => "path/to/DOC.bin",
    DON => "path/to/DON.bin",
    DOP => "path/to/DOP.bin",
    POC => "path/to/POC.bin",
    PON => "path/to/PON.bin",
    POP => "path/to/POP.bin")
```

## Time

Model time `t` is presented in second, and start from 0 by default.

## Simulation

A `PI_simulation` includes a `PI_model` and its time steps `nÎ”T`, `Î”T`.
It will be time steped by [`update!'](@ref).

```@docs
PI_simulation
```

## Diagnostics

Model diagnostics are specified by `diag_ntrs` (for tracers) and `diag_nprocs` (for individuals).
Diagnostics for individuals are aggregated into tracer fields.

A full list of available diagnostics are provided below:

```julia
diag_ntrs = (:PAR, :DIC, :NH4, :NO3, :PO4, :DOC, :DON, :DOP, :POC, :PON, :POP)

diag_nprocs = (:num,  # number of individuals
               :graz, # number of grazed individuals
               :mort, # number of died individuals
               :dvid, # number of divided individuals
               :PS,   # photosynthesis rate
               :BS,   # biosynthesis rate
               :VDOC, # DOC uptake rate
               :VHN4, # NH4 uptake rate
               :VNO3, # NO3 uptake rate
               :VPO4, # PO4 uptake rate
               :resp, # respiration rate
               :exu,  # exudation rate
               :Bm,   # functional biomass
               :Cq,   # Carbon pool
               :Nq,   # Nitrogen pool
               :Pq,   # Phosphorus pool
               :chl   # Chla
               )
```

## Output

Currently, we only support two types of output which are both save in `JLD2` files.
The first type of output is for `individual`s. The current state of all the `individuals`
at each time step of a `PI_simulation` will be saved in a single file named `individuals.jld2`.
An example structure of `individuals.jld2` is shown below.

```julia
julia> jldopen("results/individuals.jld2") # only the location and cell size is saved for now
JLDFile /home/zhenwu/PI_GPU/results/individuals.jld2 (read-only)
 â”œâ”€ğŸ“‚ 0000000060
 â”‚  â””â”€ğŸ“‚ sp1
 â”‚     â”œâ”€ğŸ”¢ x
 â”‚     â”œâ”€ğŸ”¢ y
 â”‚     â”œâ”€ğŸ”¢ z
 â”‚     â””â”€ğŸ”¢ Sz
 â””â”€ğŸ“‚ 0000000120
    â””â”€ğŸ“‚ sp1
       â”œâ”€ğŸ”¢ x
       â”œâ”€ğŸ”¢ y
       â”œâ”€ğŸ”¢ z
       â””â”€ğŸ”¢ Sz
```

The second type of output is for diagnostics. `individual`s at each time step will be aggregated into tracer fields.
The frequency of diagnostics is specified by `diag_freq` in `PI_simulation`.
Only diagnostics specified by `diag_ntrs` and `diag_nprocs` in `PI_Model` will be saved.
All the diagnostics of a `PI_simulation` will be saved in a single file named `diags.jld2`.
An example structure of `diags.jld2` is shown below.

```julia
julia> jldopen("results/diags.jld2")
JLDFile /home/zhenwu/PI_GPU/results/diags.jld2 (read-only)
 â”œâ”€ğŸ“‚ 0000000060
 â”‚  â”œâ”€ğŸ“‚ nut
 â”‚  â”‚  â”œâ”€ğŸ”¢ PAR
 â”‚  â”‚  â”œâ”€ğŸ”¢ DOC
 â”‚  â”‚  â”œâ”€ğŸ”¢ NH4
 â”‚  â”‚  â””â”€ğŸ”¢ NO3
 â”‚  â””â”€ğŸ“‚ sp1
 â”‚     â”œâ”€ğŸ”¢ num
 â”‚     â”œâ”€ğŸ”¢ graz
 â”‚     â”œâ”€ğŸ”¢ mort
 â”‚     â””â”€ğŸ”¢ dvid
 â””â”€ğŸ“‚ 0000000120
    â”œâ”€ğŸ“‚ nut
    â”‚  â”œâ”€ğŸ”¢ PAR
    â”‚  â”œâ”€ğŸ”¢ DOC
    â”‚  â”œâ”€ğŸ”¢ NH4
    â”‚  â””â”€ğŸ”¢ NO3
    â””â”€ğŸ“‚ sp1
       â”œâ”€ğŸ”¢ num
       â”œâ”€ğŸ”¢ graz
       â”œâ”€ğŸ”¢ mort
       â””â”€ğŸ”¢ dvid
```
